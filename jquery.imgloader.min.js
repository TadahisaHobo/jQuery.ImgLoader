/*! jQuery.ImgLoader - v0.1.0 -  7/31/2012
 * https://github.com/Takazudo/jQuery.ImgLoader
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */// Generated by CoffeeScript 1.3.3
(function(){var e=[].slice,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};(function(t,r,i){var s,o;return s=t.ImgLoaderNs={},s.createCachedFunction=function(e){var n;return n={},function(r){return n[r]||(n[r]=t.Deferred(function(t){return e(t,r)}).promise()),n[r]}},s.fetchImg=s.createCachedFunction(function(e,n){var r,i,s;return s=new Image,i=function(){return s.onload=s.onerror=null},e.always(i),r=t(s),s.onload=function(){return e.resolve(r)},s.onerror=function(){return e.reject(r)},s.src=n}),function(){var e;return e={},s.loadImg=function(n){return t.Deferred(function(t){return s.fetchImg(n).then(function(r){var i,s;return e[n]||(e[n]=r),i=e[n],s=i.clone(),e[n]=s,t.resolve(i)},function(e){return t.reject(e)})}).promise()}}(),o=function(e){return t.Deferred(function(t){return setTimeout(function(){return t.resolve()},e)})},s.Event=function(){function t(){this._callbacks={}}return t.prototype.bind=function(e,t){var n,r,i,s,o;n=e.split(" ");for(s=0,o=n.length;s<o;s++)r=n[s],(i=this._callbacks)[r]||(i[r]=[]),this._callbacks[r].push(t);return this},t.prototype.one=function(e,t){return this.bind(e,function(){return this.unbind(e,arguments.callee),t.apply(this,arguments)})},t.prototype.trigger=function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],r=t.shift(),i=(u=this._callbacks)!=null?u[r]:void 0;if(!i)return;for(s=0,o=i.length;s<o;s++){n=i[s];if(n.apply(this,t)===!1)break}return this},t.prototype.unbind=function(e,t){var n,r,i,s,o,u;if(!e)return this._callbacks={},this;i=(u=this._callbacks)!=null?u[e]:void 0;if(!i)return this;if(!t)return delete this._callbacks[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this._callbacks[e]=i;break}return this},t}(),s.LoaderItem=function(e){function r(e){this.src=e,r.__super__.constructor.apply(this,arguments)}return n(r,e),r.prototype.load=function(){var e=this;return t.Deferred(function(t){return s.loadImg(e.src).pipe(function(n){return e.$img=n,e.trigger("success",e.$img),e.trigger("complete",e.$img),t.resolve(e.$img)},function(n){return e.$img=n,e.trigger("error",e.$img),e.trigger("complete",e.$img),t.reject(e.$img)})}).promise()},r}(s.Event),s.BasicLoader=function(r){function i(){i.__super__.constructor.apply(this,arguments),this.items=[]}return n(i,r),i.prototype.add=function(e){var n;return t.type(e)==="string"&&(n=e,e=new s.LoaderItem(n)),this.items.push(e),e},i.prototype.load=function(){var n,r,i=this;return n=0,r=t.map(this.items,function(e){return e.bind("complete",function(e){return i.trigger("itemload",e,n),n++}).load()}),t.Deferred(function(n){return t.when.apply(i,r).always(function(){var r,s;return s=1<=arguments.length?e.call(arguments,0):[],r=t(s),i.trigger("allload",r),n.resolve(r)})})},i.prototype.kill=function(){return t.each(this.items,function(e,t){return t.unbind()}),this.trigger("kill"),this.unbind(),this},i}(s.Event),s.ChainLoader=function(e){function r(e,n){this._pipesize=e,this._delay=n!=null?n:0,r.__super__.constructor.apply(this,arguments),this._presets=[],this._doneCount=0,this._inLoadCount=0,this._allDoneDefer=t.Deferred()}return n(r,e),r.prototype._finished=function(){return this._doneCount===this._presets.length},r.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},r.prototype._getImgs=function(){return t(t.map(this._presets,function(e){return e.item.$img}))},r.prototype._handleNext=function(){var e,n=this;return this._finished()?this._allloadFired?this:(this._allloadFired=!0,e=this._getImgs(),this.trigger("allload",e),this._allDoneDefer.resolve(e),this):(t.each(this._presets,function(e,t){return t.started?!0:n._nextLoadAllowed()?(n._inLoadCount++,t.started=!0,t.item.one("complete",function(r){return t.done=!0,setTimeout(function(){var i;return i=function(){return n.trigger("itemload",r,n._doneCount),n._inLoadCount--,n._doneCount++,t.defer.resolve(r),n._handleNext()},e===0?i():n._presets[e-1].defer.always(function(){return i()})},n._delay)}),t.item.load()):!1}),this)},r.prototype.add=function(e){var n,r;return t.type(e)==="string"&&(r=e,e=new s.LoaderItem(r)),n={item:e,done:!1,started:!1,defer:t.Deferred()},this._presets.push(n),n.defer},r.prototype.load=function(){return this._handleNext(),this._allDoneDefer},r.prototype.kill=function(){return t.each(this._presets,function(e,t){return t.item.unbind()}),this.trigger("kill"),this.unbind(),this},r}(s.Event),s.LoaderFacade=function(){function i(e){var n,r=this;if(!(this instanceof arguments.callee))return new s.LoaderFacade(e);this.options=n=t.extend({srcs:[],pipesize:0,delay:100},e),n.pipesize?this.loader=new s.ChainLoader(n.pipesize,n.delay):this.loader=new s.BasicLoader,t.each(n.srcs,function(e,t){return r.loader.add(new s.LoaderItem(t))})}var n,r=this;return n=["bind","trigger","load","one","unbind","add","kill"],t.each(n,function(t,n){return i.prototype[n]=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.loader[n].apply(this.loader,t)}}),i}.call(this),function(){var e,n,r,i,u;return r={},e=null,n=function(){return t.Deferred(function(n){return t(function(){return e=t('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),t("body").append(e),n.resolve()})}).promise()},i=function(e){return e.naturalWidth===void 0||e.naturalWidth===0||e.naturalHeight===void 0||e.naturalHeight===0?!1:!0},u=function(n,i){var s;return n=n.clone(),s=n[0],t.Deferred(function(u){var a,f,l,c;return c={},n.css({width:"auto",height:"auto"}),a=t("<div></div>").append(n),e.append(a),f=0,l=function(){return c.width=s.naturalWidth||n.width(),c.height=s.naturalHeight||n.height(),f>10?(a.remove(),u.reject()):!c.width||!c.height?(f++,o(100).done(function(){return l()})):(r[i],a.remove(),u.resolve(c))},l()}).promise()},s.calcNaturalWH=s.createCachedFunction(function(e,t){return s.loadImg(t).then(function(s){var o,a;return o=s[0],i(o)?(a={width:o.naturalWidth,height:o.naturalHeight},r[t]=a,e.resolve(a,s)):n().done(function(){return u(s,t).then(function(t){return e.resolve(t,s)},function(){return e.reject()})})},function(){return e.reject()})})}(),t.loadImg=s.loadImg,t.ImgLoader=s.LoaderFacade,t.calcNaturalWH=s.calcNaturalWH})(jQuery,this,this.document)}).call(this);