/*! jQuery.ImgLoader (https://github.com/Takazudo/jQuery.ImgLoader)
 * lastupdate: 2013-05-17
 * version: 0.3.0
 * author: Takeshi Takatsudo 'Takazudo' <takazudo@gmail.com>
 * License: MIT */
(function(){var t=[].slice,e={}.hasOwnProperty,r=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};(function(e,n){var o,i;return o=e.ImgLoaderNs={},o.support={},o.support.xhr2=null!=n.FormData,o.createCachedFunction=function(t){var r;return r={},function(n,o){return r[n]||(r[n]=e.Deferred(function(e){return t(e,n,o)}).promise()),r[n]}},o.fetchImg=o.createCachedFunction(function(t,r,n){var i,u,s,a;return s=new Image,u=function(){return s.onload=s.onerror=null},t.always(u),i=e(s),s.onload=function(){return t.resolve(i)},s.onerror=function(){return t.reject(i)},o.support.xhr2&&(null!=n?n.useXHR2:void 0)?(a=new o.Xhr2Request(r,{timeout:n.timeout}),t.xhr=a,a.on("progress",function(){return t.notify(a.currentLoadedInfo())}),a.on("loadend timeout",function(){return s.src=r}),a.send()):s.src=r}),function(){var t;return t={},o.loadImg=function(r,n,i){return e.Deferred(function(e){return o.fetchImg(r,{useXHR2:n,timeout:i}).progress(function(t){return e.notify(t)}).then(function(n){var o,i;return t[r]||(t[r]=n),o=t[r],i=o.clone(),t[r]=i,e.resolve(o)},function(t){return e.reject(t)})}).promise()}}(),i=function(t){return e.Deferred(function(e){return setTimeout(function(){return e.resolve()},t)})},o.Event=function(){function e(){this._callbacks={}}return e.prototype.on=function(t,e){var r,n,o,i,u;for(r=t.split(" "),i=0,u=r.length;u>i;i++)n=r[i],(o=this._callbacks)[n]||(o[n]=[]),this._callbacks[n].push(e);return this},e.prototype.one=function(t,e){return this.on(t,function(){return this.off(t,arguments.callee),e.apply(this,arguments)})},e.prototype.trigger=function(){var e,r,n,o,i,u,s;if(e=arguments.length>=1?t.call(arguments,0):[],n=e.shift(),o=null!=(s=this._callbacks)?s[n]:void 0){for(i=0,u=o.length;u>i&&(r=o[i],r.apply(this,e)!==!1);i++);return this}},e.prototype.off=function(t,e){var r,n,o,i,u,s;if(!t)return this._callbacks={},this;if(o=null!=(s=this._callbacks)?s[t]:void 0,!o)return this;if(!e)return delete this._callbacks[t],this;for(n=i=0,u=o.length;u>i;n=++i)if(r=o[n],r===e){o=o.slice(),o.splice(n,1),this._callbacks[t]=o;break}return this},e.prototype.bind=function(){return this.on.apply(this,arguments)},e.prototype.unbind=function(){return this.off.apply(this,arguments)},e}(),o.Xhr2Request=function(t){function n(t,r){this.url=t,n.__super__.constructor.apply(this,arguments),this.options=e.extend({timeout:1e4},r),this._prepare()}return r(n,t),n.prototype._prepare=function(){var t,e=this;return t=!1,this._request=new XMLHttpRequest,this._request.open("GET",this.url),this._request.timeout=this.options.timeout,this._request.onloadend=function(){return e.trigger("loadend")},this._request.onprogress=function(r){return t||(t=!0,e.totalSize=r.totalSize,e.trigger("firstprogress")),e.loadedSize=r.loaded,e.loadedRatio=e.loadedSize/e.totalSize,e.trigger("progress")},this._request.ontimeout=function(){return e.options.timeout},this},n.prototype.currentLoadedInfo=function(){return{totalSize:this.totalSize,loadedSize:this.loadedSize,loadedRatio:this.loadedRatio}},n.prototype.send=function(){return this._request.send(),this},n}(o.Event),o.LoaderItem=function(t){function n(t,e,r){this.src=t,this._useXHR2=null!=e?e:!0,this._timeout=null!=r?r:1e4,n.__super__.constructor.apply(this,arguments)}return r(n,t),n.prototype.load=function(){var t=this;return e.Deferred(function(e){return o.loadImg(t.src,t._useXHR2,t._timeout).progress(function(e){return t.trigger("progress",e)}).then(function(r){return t.$img=r,t.trigger("success",t.$img),t.trigger("complete",t.$img),e.resolve(t.$img)},function(r){return t.$img=r,t.trigger("error",t.$img),t.trigger("complete",t.$img),e.reject(t.$img)})})},n}(o.Event),o.AbstractLoader=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype._prepareProgressInfo=function(){var t,e,r;return t=this.items||this._presets,e=t.length,this.progressInfo=r={loadedFileCount:0,totalFileCount:e,loadedRatio:0},this.ratioPerItem=1/e,this},e.prototype._updateProgressInfo=function(t,e){var r,n;return n=this.progressInfo,r=e.loadedRatio*this.ratioPerItem,n.loadedRatio=n.loadedRatio+r-(t.lastLoadedRatio||0),n.loadedRatio>1&&(n.loadedRatio=1),t.lastLoadedRatio=r,this},e}(o.Event),o.BasicLoader=function(n){function i(t,e){this._useXHR2=null!=t?t:!0,this._timeout=null!=e?e:1e4,i.__super__.constructor.apply(this,arguments),this.items=[]}return r(i,n),i.prototype.add=function(t){var r;return"string"===e.type(t)&&(r=t,t=new o.LoaderItem(r,this._useXHR2,this._timeout)),this.items.push(t),t},i.prototype.load=function(){var r,n,i=this;return this._prepareProgressInfo(),n=this.progressInfo,r=e.map(this.items,function(t){return t.on("progress",function(e){return i._updateProgressInfo(t,e),i.trigger("progress",n)}),t.on("complete",function(t){return n.loadedFileCount+=1,o.support.xhr2&&i._useXHR2||(n.loadedRatio=n.loadedFileCount/n.totalFileCount,i.trigger("progress",n)),i.trigger("itemload",t,n)}),t.load()}),e.Deferred(function(o){return e.when.apply(i,r).always(function(){var r,u;return u=arguments.length>=1?t.call(arguments,0):[],r=e(u),n.loadedRatio=1,i.trigger("progress",n),i.trigger("allload",r,n),o.resolve(r,n)})}).promise()},i.prototype.kill=function(){var t,e,r,n;for(n=this.items,e=0,r=n.length;r>e;e++)t=n[e],t.off();return this.trigger("kill"),this.off(),this},i}(o.AbstractLoader),o.ChainLoader=function(t){function n(t,r,o,i){this._pipesize=t,this._delay=null!=r?r:0,this._useXHR2=o,this._timeout=i,n.__super__.constructor.apply(this,arguments),this._presets=[],this._inLoadCount=0,this._allDoneDefer=e.Deferred()}return r(n,t),n.prototype._finished=function(){return this.progressInfo.loadedFileCount===this._presets.length},n.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},n.prototype._getImgs=function(){return e(e.map(this._presets,function(t){return t.item.$img}))},n.prototype._handleNext=function(){var t,r,n=this;return r=this.progressInfo,this._finished()?this._allloadFired?this:(this._allloadFired=!0,t=this._getImgs(),this.trigger("progress",r),this.trigger("allload",t,r),this._allDoneDefer.resolve(t),this):(e.each(this._presets,function(t,e){var u;return u=e.item,e.started?!0:n._nextLoadAllowed()?(n._inLoadCount+=1,e.started=!0,u.on("progress",function(t){return n._updateProgressInfo(u,t),n.trigger("progress",r)}),u.on("complete",function(u){var s;return e.done=!0,s=function(){return r.loadedFileCount+=1,n._inLoadCount-=1,o.support.xhr2&&n._useXHR2||(r.loadedRatio=r.loadedFileCount/r.totalFileCount,n.trigger("progress",r)),n.trigger("itemload",u,r),e.defer.resolve(u),i(n._delay).done(function(){return n._handleNext()})},0===t?s():n._presets[t-1].defer.always(function(){return s()})}),u.load()):!1}),this)},n.prototype.add=function(t){var r,n;return"string"===e.type(t)&&(n=t,t=new o.LoaderItem(n,this._useXHR2,this._timeout)),r={item:t,done:!1,started:!1,defer:e.Deferred()},this._presets.push(r),r.defer},n.prototype.load=function(){return this._prepareProgressInfo(),this._handleNext(),this._allDoneDefer},n.prototype.kill=function(){var t,e,r,n;for(n=this._presets,e=0,r=n.length;r>e;e++)t=n[e],t.item.off();return this.trigger("kill"),this.off(),this},n}(o.AbstractLoader),o.LoaderFacade=function(){function r(t){var r,n,i,u,s;for(this.options=r=e.extend({srcs:[],pipesize:0,delay:100,timeout:1e4,useXHR2:!1},t),this.loader=r.pipesize?new o.ChainLoader(r.pipesize,r.delay,r.useXHR2,r.timeout):new o.BasicLoader(r.useXHR2,r.timeout),s=r.srcs,i=0,u=s.length;u>i;i++)n=s[i],this.loader.add(n)}var n,i,u,s,a;for(i=["bind","trigger","on","off","load","one","unbind","add","kill"],u=function(e){return r.prototype[e]=function(){var r;return r=arguments.length>=1?t.call(arguments,0):[],this.loader[e].apply(this.loader,r)}},s=0,a=i.length;a>s;s++)n=i[s],u(n);return r}.call(this),function(){var t,r,n,u,s;return n={},t=null,r=function(){return e.Deferred(function(r){return e(function(){return t=e('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),e("body").append(t),r.resolve()})}).promise()},u=function(t){return null==t.naturalWidth||0===t.naturalWidth||null==t.naturalHeight||0===t.naturalHeight?!1:!0},s=function(r,o){var u;return r=r.clone(),u=r[0],e.Deferred(function(s){var a,l,h,c;return c={},r.css({width:"auto",height:"auto"}),a=e("<div></div>").append(r),t.append(a),l=0,h=function(){return c.width=u.naturalWidth||r.width(),c.height=u.naturalHeight||r.height(),l>10?(a.remove(),s.reject()):c.width&&c.height?(n[o],a.remove(),s.resolve(c)):(l++,i(100).done(function(){return h()}))},h()}).promise()},o.calcNaturalWH=o.createCachedFunction(function(t,e){return o.loadImg(e).then(function(o){var i,a;return i=o[0],u(i)?(a={width:i.naturalWidth,height:i.naturalHeight},n[e]=a,t.resolve(a,o)):r().done(function(){return s(o,e).then(function(e){return t.resolve(e,o)},function(){return t.reject()})})},function(){return t.reject()})})}(),o.calcRectFitImgWH=function(){var t,r,n;return t=function(t,e){return t>e?t:e},r=function(t,e,r,n){var o,i;return r>t&&n>e?{width:t,height:e}:(i=r/t,o=n/e,o>i?{width:r,height:Math.ceil(e*i)}:i>o?{width:Math.ceil(t*o),height:n}:i===o?{width:t*i,height:e*o}:void 0)},n=function(t){return{width:100*t.width,height:100*t.height}},function(t,i){var u,s,a,l;return a=e.extend({width:null,height:null,enlargeSmallImg:!0,returnClonedImg:!0},i),u=e.Deferred(),l=function(t,e){var o;return a.enlargeSmallImg&&(t=n(t)),a.returnClonedImg&&(e=e.clone()),o=r(t.width,t.height,a.width,a.height),u.resolve({width:o.width,height:o.height,img:e})},s=function(){return u.reject()},o.calcNaturalWH(t).then(l,s),u.promise()}}(),e.loadImg=o.loadImg,e.ImgLoader=o.LoaderFacade,e.calcNaturalWH=o.calcNaturalWH,e.calcRectFitImgWH=o.calcRectFitImgWH})(jQuery,this,this.document)}).call(this);