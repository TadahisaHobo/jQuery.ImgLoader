(function(){var a,b=Array.prototype.slice,c=Object.prototype.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};a=$.ImgLoaderNs={},a.createCachedFunction=function(a){var b;return b={},function(c){return b[c]||(b[c]=$.Deferred(function(b){return a(b,c)}).promise()),b[c]}},a.fetchImg=a.createCachedFunction(function(a,b){var c,d;return d=new Image,c=function(){return d.onload=d.onerror=null},a.always(c),d.onload=function(){return a.resolve($(d))},d.onerror=function(){return a.reject({msg:"img load failed"})},d.src=b}),function(){var b;return b={},a.loadImg=function(c){return $.Deferred(function(d){return a.fetchImg(c).then(function(a){var e,f;return b[c]||(b[c]=a),e=b[c],f=e.clone(),b[c]=f,d.resolve(e)},function(a){return d.reject(a)})}).promise()}}(),a.Event=function(){function a(){this._callbacks={}}return a.prototype.bind=function(a,b){var c,d,e,f,g;c=a.split(" ");for(f=0,g=c.length;f<g;f++)d=c[f],(e=this._callbacks)[d]||(e[d]=[]),this._callbacks[d].push(b);return this},a.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},a.prototype.trigger=function(){var a,c,d,e,f,g,h;a=1<=arguments.length?b.call(arguments,0):[],d=a.shift(),e=(h=this._callbacks)!=null?h[d]:void 0;if(!e)return;for(f=0,g=e.length;f<g;f++){c=e[f];if(c.apply(this,a)===!1)break}return this},a.prototype.unbind=function(a,b){var c,d,e,f,g;if(!a)return this._callbacks={},this;e=(g=this._callbacks)!=null?g[a]:void 0;if(!e)return this;if(!b)return delete this._callbacks[a],this;for(d=0,f=e.length;d<f;d++){c=e[d];if(c!==b)continue;e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},a}(),a.LoaderItem=function(b){function c(a){this.src=a,c.__super__.constructor.apply(this,arguments)}return d(c,b),c.prototype.load=function(){var b=this;return $.Deferred(function(c){return a.loadImg(b.src).then(function(a){return b.$img=a,b.trigger("load",a),c.resolve(a)},function(a){return b.trigger("load",$("<img src='"+b.src+"'>"))})}).promise()},c}(a.Event),a.BasicLoader=function(c){function e(){e.__super__.constructor.apply(this,arguments),this.items=[]}return d(e,c),e.prototype.add=function(b){var c;return $.type(b)==="string"&&(c=b,b=new a.LoaderItem(c)),this.items.push(b),this},e.prototype.load=function(){var a,c,d=this;return a=0,c=$.map(this.items,function(b){return b.bind("load",function(b){return d.trigger("itemload",b,a),a++}).load()}),$.Deferred(function(a){return $.when.apply(d,c).always(function(){var c,e;return e=1<=arguments.length?b.call(arguments,0):[],c=$(e),d.trigger("allload",c),a.resolve(c)})})},e}(a.Event),a.ChainLoader=function(b){function c(a,b){this._chainsize=a,this._delay=b!=null?b:0,c.__super__.constructor.apply(this,arguments),this._presets=[],this._doneCount=0,this._inLoadCount=0,this._allDoneDefer=$.Deferred()}return d(c,b),c.prototype._finished=function(){return this._doneCount===this._presets.length},c.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._chainsize},c.prototype._getImgs=function(){return $($.map(this._presets,function(a){return a.item.$img}))},c.prototype._handleNext=function(){var a,b=this;return this._finished()&&(a=this._getImgs(),this.trigger("allload",a),this._allDoneDefer.resolve(a),this),$.each(this._presets,function(a,c){return c.started?!0:b._nextLoadAllowed()?(b._inLoadCount++,c.started=!0,c.item.one("load",function(d){return c.done=!0,setTimeout(function(){var e;return e=function(){return b.trigger("itemload",d,b._doneCount),b._inLoadCount--,b._doneCount++,c.defer.resolve(),b._handleNext()},a===0?e():b._presets[a-1].defer.always(function(){return e()})},b._delay)}),c.item.load()):!1}),this},c.prototype.add=function(b){var c;return $.type(b)==="string"&&(c=b,b=new a.LoaderItem(c)),this._presets.push({item:b,done:!1,started:!1,defer:$.Deferred()}),this},c.prototype.load=function(){return this._handleNext(),this._allDoneDefer},c}(a.Event),a.Facade=function(){function d(b,c){var d,e=this;this._srcs=b;if(this instanceof arguments.callee)this.options=d=$.extend({chainsize:0,delay:100},c),d.chainsize?this.loader=new a.ChainLoader(d.chainsize,d.delay):this.loader=new a.BasicLoader,$.each(this._srcs,function(b,c){return e.loader.add(new a.LoaderItem(c))});else return new a.Facade(b,c)}var c=this;return function(){var a;return a=["bind","trigger","load","one","unbind","add"],$.each(a,function(a,c){return d.prototype[c]=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.loader[c].apply(this.loader,a)}})}(),d}.call(this),$.loadImg=a.loadImg,$.ImgLoader=a.Facade}).call(this)